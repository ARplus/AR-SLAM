<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>千佛洞AR体验</title>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        /* Your CSS remains largely the same, but we will hide the overlays by default */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: relative;
        }
        #ar-scene {
            width: 100%;
            height: 100%;
        }
        /* Overlays should be hidden initially */
        .start-overlay, .loading-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            background: rgba(0,0,0,0.8);
            z-index: 10;
        }
        .start-button {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            color: #333;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }
         .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body ui-loading="loading" ui-scanning="scanning" ui-error="error">

    <div class="container">
        <a-scene
            id="ar-scene"
            mindar-image="imageTargetSrc: https://arplus.github.io/AR-SLAM/qianfo.mind; autoStart: false; uiLoading: #loadingOverlay; uiScanning: #scanningOverlay; uiError: #errorOverlay"
            color-space="sRGB"
            embedded
            renderer="colorManagement: true, physicallyCorrectLights: true"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false"
        >
            <a-assets>
                <video 
                    id="arVideo" 
                    src="https://freela.oss-cn-beijing.aliyuncs.com/AvatarGPTtest/Aurora01.mp4"
                    autoplay 
                    loop 
                    muted 
                    playsinline 
                    webkit-playsinline
                    crossorigin="anonymous">
                </video>
            </a-assets>

            <a-entity id="targetEntity" mindar-image-target="targetIndex: 0">
                <a-video 
                    id="videoPlane"
                    src="#arVideo"
                    width="1.2"
                    height="0.675"
                    position="0 0 0"
                    rotation="-90 0 0"
                    opacity="0.95">
                </a-video>
                <a-ring 
                    color="#FFD700" 
                    radius-inner="0.7" 
                    radius-outer="0.75"
                    position="0 0 -0.05"
                    rotation="-90 0 0"
                    opacity="0.8"
                    animation="property: rotation; to: -90 360 0; loop: true; dur: 8000; easing: linear">
                </a-ring>
            </a-entity>
        </a-scene>

        <div class="start-overlay" id="startOverlay">
            <button class="start-button" id="startButton">开始AR之旅</button>
        </div>

        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div>正在启动AR引擎...</div>
        </div>
        <div class="loading-overlay" id="scanningOverlay" style="display: none;">
            <div>请扫描千佛洞图标</div>
        </div>
         <div class="loading-overlay" id="errorOverlay" style="display: none;">
            <div>AR启动失败。请刷新页面重试。</div>
        </div>
    </div>

    <script>
        // CHANGE: Simplified the JavaScript significantly.
        document.addEventListener('DOMContentLoaded', () => {
            const startButton = document.querySelector('#startButton');
            const startOverlay = document.querySelector('#startOverlay');
            const sceneEl = document.querySelector('a-scene');
            const arSystem = sceneEl.systems["mindar-image"];
            const video = document.querySelector("#arVideo");
            
            // 1. Add a click listener to the start button
            startButton.addEventListener('click', () => {
                // When clicked, start the AR system
                arSystem.start(); 
                // Hide the start overlay
                startOverlay.style.display = 'none';
            });

            const targetEntity = document.querySelector('#targetEntity');

            // 2. Listen for the targetFound event
            targetEntity.addEventListener("targetFound", event => {
                console.log("Target found");
                // Attempt to play the video when the target is found
                video.play().catch(e => console.error("Video play failed:", e));
            });

             // 3. Listen for the targetLost event to pause
             targetEntity.addEventListener("targetLost", event => {
                console.log("Target lost");
                video.pause();
            });
        });
    </script>
</body>
</html>
