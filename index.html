<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        .start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1000;
            color: white;
        }
        
        .start-button {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .start-button:hover {
            background: #45a049;
        }
        
        .hidden {
            display: none;
        }
        
        .status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 999;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- 启动界面 -->
    <div class="start-overlay" id="startOverlay">
        <h2>千佛洞AR体验</h2>
        <p>点击开始启动AR摄像头</p>
        <button class="start-button" id="startButton">开始AR体验</button>
    </div>
    
    <!-- 状态显示 -->
    <div class="status" id="status">准备启动</div>

    <!-- AR场景 -->
    <a-scene 
        id="arScene"
        mindar-image="imageTargetSrc: ./qianfo.mind; autoStart: false;" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <video 
                id="arVideo" 
                src="https://freela.oss-cn-beijing.aliyuncs.com/AvatarGPTtest/Aurora01.mp4"
                loop 
                muted 
                playsinline 
                webkit-playsinline
                crossorigin="anonymous">
            </video>
        </a-assets>
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        
        <a-entity mindar-image-target="targetIndex: 0">
            <a-video 
                src="#arVideo"
                width="1" 
                height="0.6" 
                position="0 0 0" 
                rotation="-90 0 0"
                opacity="0.9">
            </a-video>
        </a-entity>
    </a-scene>

    <script>
        const startOverlay = document.getElementById('startOverlay');
        const startButton = document.getElementById('startButton');
        const status = document.getElementById('status');
        const sceneEl = document.getElementById('arScene');
        
        function updateStatus(message) {
            status.textContent = message;
            console.log(message);
        }

        // 等待A-Frame场景加载完成
        sceneEl.addEventListener('loaded', () => {
            updateStatus('AR场景已加载，点击开始');
        });

        // 启动按钮点击事件
        startButton.addEventListener('click', async () => {
            try {
                updateStatus('请求摄像头权限...');
                
                // 1. 先明确请求摄像头权限
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // 后置摄像头
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                updateStatus('摄像头权限已获取');
                
                // 2. 立即释放这个测试流，让MindAR接管
                stream.getTracks().forEach(track => track.stop());
                
                updateStatus('正在启动AR系统...');
                
                // 3. 获取MindAR系统
                const arSystem = sceneEl.systems["mindar-image"];
                
                if (!arSystem) {
                    throw new Error('MindAR系统未找到');
                }
                
                // 4. 启动AR（这时摄像头权限已经获得）
                await arSystem.start();
                
                // 5. 隐藏启动界面
                startOverlay.classList.add('hidden');
                updateStatus('AR已启动，请扫描图片');
                
                // 6. 设置视频控制
                setupVideoControl();
                
            } catch (error) {
                console.error('启动失败:', error);
                
                let errorMsg = '未知错误';
                if (error.name === 'NotAllowedError') {
                    errorMsg = '摄像头权限被拒绝，请允许摄像头访问';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = '未找到摄像头设备';
                } else if (error.name === 'NotSupportedError') {
                    errorMsg = '浏览器不支持摄像头功能';
                } else {
                    errorMsg = error.message;
                }
                
                updateStatus('启动失败: ' + errorMsg);
                alert('启动失败: ' + errorMsg + '\n\n请尝试:\n1. 刷新页面\n2. 检查摄像头权限\n3. 使用Chrome浏览器');
            }
        });

        function setupVideoControl() {
            const targetEntity = document.querySelector('[mindar-image-target]');
            const video = document.querySelector('#arVideo');

            targetEntity.addEventListener('targetFound', () => {
                updateStatus('目标发现！播放视频');
                video.play().catch(e => {
                    console.error('视频播放失败:', e);
                    updateStatus('视频播放失败');
                });
            });

            targetEntity.addEventListener('targetLost', () => {
                updateStatus('目标丢失，暂停视频');
                video.pause();
            });
        }
    </script>
</body>
</html>
