<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }
        
        .start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1000;
            color: white;
        }
        
        .start-button {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .start-button:hover {
            background: #45a049;
        }
        
        .start-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none;
        }
        
        .status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #4CAF50;
            padding: 10px 15px;
            border-radius: 20px;
            z-index: 999;
            font-size: 14px;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        /* æ‘„åƒå¤´è§†é¢‘å®¹å™¨ */
        .camera-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: #000;
        }
        
        #cameraVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* ARåœºæ™¯å±‚ */
        a-scene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 2 !important;
            background: transparent !important;
        }
        
        a-scene canvas {
            background: transparent !important;
        }
        
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 3px solid rgba(76, 175, 80, 0.3);
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 500;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .ar-status {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 999;
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- å¯åŠ¨ç•Œé¢ -->
    <div class="start-overlay" id="startOverlay">
        <h2>ğŸ›ï¸ åƒä½›æ´ARä½“éªŒ</h2>
        <p>é¦–å…ˆå¯åŠ¨æ‘„åƒå¤´æ˜¾ç¤ºå®æ™¯</p>
        <p>ç„¶ååŠ è½½ARè¯†åˆ«åŠŸèƒ½</p>
        <button class="start-button" id="startButton">å¯åŠ¨æ‘„åƒå¤´</button>
        <div style="margin-top: 20px; font-size: 14px; opacity: 0.8;">
            è¯·ç¡®ä¿å…‰çº¿å……è¶³å¹¶å…è®¸æ‘„åƒå¤´æƒé™
        </div>
    </div>
    
    <!-- çŠ¶æ€æ˜¾ç¤º -->
    <div class="status" id="status">å‡†å¤‡å¯åŠ¨æ‘„åƒå¤´</div>
    
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading-spinner hidden" id="loadingSpinner"></div>
    
    <!-- æ‘„åƒå¤´è§†é¢‘å®¹å™¨ -->
    <div class="camera-container hidden" id="cameraContainer">
        <video id="cameraVideo" autoplay muted playsinline webkit-playsinline></video>
    </div>
    
    <!-- ARçŠ¶æ€ -->
    <div class="ar-status hidden" id="arStatus">æ­£åœ¨åˆå§‹åŒ–ARç³»ç»Ÿ...</div>

    <!-- ARåœºæ™¯ (é€æ˜å±‚) -->
    <a-scene 
        id="arScene"
        mindar-image="imageTargetSrc: ./qianfo.mind; autoStart: false;" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false"
        embedded
        renderer="colorManagement: true, physicallyCorrectLights: true, alpha: true"
        background="color: transparent"
        class="hidden">
        
        <a-assets>
            <video 
                id="arVideo" 
                src="https://freela.oss-cn-beijing.aliyuncs.com/AvatarGPTtest/Aurora01.mp4"
                loop 
                muted 
                playsinline 
                webkit-playsinline
                crossorigin="anonymous">
            </video>
        </a-assets>
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        
        <a-entity mindar-image-target="targetIndex: 0">
            <a-video 
                src="#arVideo"
                width="1" 
                height="0.6" 
                position="0 0 0" 
                rotation="-90 0 0"
                opacity="0.9">
            </a-video>
        </a-entity>
    </a-scene>

    <script>
        // DOMå…ƒç´ 
        const startOverlay = document.getElementById('startOverlay');
        const startButton = document.getElementById('startButton');
        const status = document.getElementById('status');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const cameraContainer = document.getElementById('cameraContainer');
        const cameraVideo = document.getElementById('cameraVideo');
        const arStatus = document.getElementById('arStatus');
        const arScene = document.getElementById('arScene');
        
        // çŠ¶æ€å˜é‡
        let cameraStream = null;
        let arSystem = null;
        let arInitialized = false;
        let arStarted = false;
        
        function updateStatus(message) {
            status.textContent = message;
            console.log('çŠ¶æ€:', message);
        }
        
        function updateArStatus(message) {
            arStatus.textContent = message;
            console.log('ARçŠ¶æ€:', message);
        }

        // ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨æ‘„åƒå¤´
        startButton.addEventListener('click', async () => {
            try {
                updateStatus('æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...');
                startButton.disabled = true;
                loadingSpinner.classList.remove('hidden');
                
                // è·å–åæ‘„åƒå¤´
                const constraints = {
                    video: {
                        facingMode: 'environment', // åæ‘„åƒå¤´
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // è®¾ç½®è§†é¢‘æµ
                cameraVideo.srcObject = cameraStream;
                
                // ç­‰å¾…è§†é¢‘åŠ è½½
                await new Promise((resolve, reject) => {
                    cameraVideo.onloadedmetadata = () => {
                        cameraVideo.play().then(() => {
                            console.log(`æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ: ${cameraVideo.videoWidth}x${cameraVideo.videoHeight}`);
                            resolve();
                        }).catch(reject);
                    };
                    setTimeout(() => reject(new Error('æ‘„åƒå¤´è§†é¢‘åŠ è½½è¶…æ—¶')), 5000);
                });
                
                // æ˜¾ç¤ºæ‘„åƒå¤´ç”»é¢
                loadingSpinner.classList.add('hidden');
                startOverlay.classList.add('hidden');
                cameraContainer.classList.remove('hidden');
                arStatus.classList.remove('hidden');
                
                updateStatus('ğŸ“¹ æ‘„åƒå¤´è¿è¡Œä¸­');
                updateArStatus('æ­£åœ¨åŠ è½½ARç³»ç»Ÿ...');
                
                // ç¬¬äºŒæ­¥ï¼šåœ¨åå°åˆå§‹åŒ–ARç³»ç»Ÿ
                setTimeout(() => {
                    initializeARSystem();
                }, 1000);
                
            } catch (error) {
                console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);
                
                let errorMsg = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥';
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'æ‘„åƒå¤´æƒé™è¢«æ‹’ç»';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = 'æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡';
                } else if (error.name === 'NotSupportedError') {
                    errorMsg = 'æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´';
                }
                
                updateStatus(`âŒ ${errorMsg}`);
                startButton.disabled = false;
                loadingSpinner.classList.add('hidden');
                
                alert(`${errorMsg}\n\nè¯·å°è¯•:\n1. åˆ·æ–°é¡µé¢\n2. æ£€æŸ¥æ‘„åƒå¤´æƒé™\n3. ä½¿ç”¨Chromeæµè§ˆå™¨`);
            }
        });

        // ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–ARç³»ç»Ÿ
        async function initializeARSystem() {
            try {
                updateArStatus('æ­£åœ¨åŠ è½½ARç»„ä»¶...');
                
                // æ˜¾ç¤ºARåœºæ™¯
                arScene.classList.remove('hidden');
                
                // ç­‰å¾…A-Frameåœºæ™¯åŠ è½½
                if (!arScene.hasLoaded) {
                    await new Promise((resolve) => {
                        arScene.addEventListener('loaded', resolve, { once: true });
                    });
                }
                
                updateArStatus('ç­‰å¾…MindARåˆå§‹åŒ–...');
                
                // ç­‰å¾…MindARç³»ç»Ÿ
                let attempts = 0;
                while (!arSystem && attempts < 20) {
                    arSystem = arScene.systems["mindar-image"];
                    if (!arSystem) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        attempts++;
                        updateArStatus(`MindARåˆå§‹åŒ–ä¸­... (${attempts}/20)`);
                    }
                }
                
                if (!arSystem) {
                    throw new Error('MindARç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥');
                }
                
                updateArStatus('æ­£åœ¨å¯åŠ¨ARè¯†åˆ«...');
                
                // ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨ARè¯†åˆ«
                await arSystem.start();
                arStarted = true;
                
                updateArStatus('ğŸ¯ ARè¯†åˆ«è¿è¡Œä¸­ - è¯·æ‰«æåƒä½›æ´å›¾ç‰‡');
                updateStatus('ğŸ” ARç³»ç»Ÿå·²å¯åŠ¨');
                
                // è®¾ç½®ARäº‹ä»¶ç›‘å¬
                setupAREvents();
                
            } catch (error) {
                console.error('ARåˆå§‹åŒ–å¤±è´¥:', error);
                updateArStatus(`âŒ ARåˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                updateStatus('ARåˆå§‹åŒ–å¤±è´¥ï¼Œä½†æ‘„åƒå¤´ä»å¯ä½¿ç”¨');
            }
        }

        // è®¾ç½®ARäº‹ä»¶ç›‘å¬
        function setupAREvents() {
            const targetEntity = document.querySelector('[mindar-image-target]');
            const arVideo = document.querySelector('#arVideo');

            if (targetEntity && arVideo) {
                targetEntity.addEventListener('targetFound', () => {
                    updateArStatus('ğŸ‰ æ£€æµ‹åˆ°åƒä½›æ´å›¾ç‰‡ï¼æ­£åœ¨æ’­æ”¾è§†é¢‘');
                    arVideo.play().catch(e => {
                        console.error('ARè§†é¢‘æ’­æ”¾å¤±è´¥:', e);
                        updateArStatus('ARè§†é¢‘æ’­æ”¾å¤±è´¥');
                    });
                });

                targetEntity.addEventListener('targetLost', () => {
                    updateArStatus('ğŸ¯ ç›®æ ‡ä¸¢å¤± - è¯·é‡æ–°æ‰«æåƒä½›æ´å›¾ç‰‡');
                    arVideo.pause();
                });
            }
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        });
        
        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                updateStatus('é¡µé¢å·²éšè—');
            } else if (cameraStream) {
                updateStatus('ğŸ“¹ æ‘„åƒå¤´è¿è¡Œä¸­');
            }
        });
    </script>
</body>
</html>
