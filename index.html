<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>千佛洞AR体验</title>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* 顶部导航 */
        .header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 1000;
            position: relative;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }
        
        .header-subtitle {
            font-size: 12px;
            color: #FFD700;
            font-weight: 400;
        }
        
        .header-icons {
            display: flex;
            gap: 15px;
        }
        
        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .icon-btn:active {
            transform: scale(0.95);
        }
        
        /* 启动界面 */
        .start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            text-align: center;
        }
        
        .start-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .start-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #FFD700;
        }
        
        .start-description {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .start-button {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            color: #333;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .start-button:active {
            transform: scale(0.95);
        }
        
        /* 加载界面 */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 998;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .loading-subtitle {
            font-size: 14px;
            opacity: 0.7;
        }
        
        /* AR场景容器 */
        .ar-container {
            flex: 1;
            position: relative;
            display: none;
        }
        
        #ar-scene {
            width: 100% !important;
            height: 100% !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
        }
        
        /* 状态指示器 */
        .status-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            z-index: 997;
            display: none;
        }
        
        .status-text {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .status-subtitle {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .status-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        /* 错误提示 */
        .error-overlay {
            position: absolute;
            top: 80px;
            left: 20px;
            right: 20px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 996;
            display: none;
        }
        
        .error-button {
            background: white;
            color: #ff0000;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
        }
        
        /* 调试信息 */
        .debug-overlay {
            position: absolute;
            top: 80px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #FFD700;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            font-family: monospace;
            z-index: 995;
            display: none;
            max-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 顶部导航 -->
        <div class="header">
            <div>
                <h1>🏛️ 千佛洞AR体验</h1>
                <div class="header-subtitle">将摄像头对准千佛洞图标</div>
            </div>
            <div class="header-icons">
                <button class="icon-btn" onclick="toggleDebug()">🔧</button>
            </div>
        </div>
        
        <!-- 启动界面 -->
        <div class="start-overlay" id="startOverlay">
            <div class="start-content">
                <div class="start-title">千佛洞数字体验</div>
                <div class="start-description">
                    体验千年佛教文化的数字化呈现<br>
                    使用手机摄像头扫描千佛洞图标
                </div>
                <button class="start-button" id="startButton" onclick="startAR()">
                    开始AR之旅
                </button>
            </div>
        </div>
        
        <!-- 加载界面 -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">正在启动摄像头...</div>
            <div class="loading-subtitle">请允许摄像头权限</div>
        </div>
        
        <!-- AR场景容器 -->
        <div class="ar-container" id="arContainer">
            <a-scene
                id="arScene"
                mindar-image="imageTargetSrc: https://arplus.github.io/AR-SLAM/qianfo.mind; filterMinCF:0.001; filterBeta: 0.01"
                color-space="sRGB"
                embedded
                renderer="colorManagement: true, physicallyCorrectLights: true"
                vr-mode-ui="enabled: false"
                device-orientation-permission-ui="enabled: false"
                background="color: #000"
            >
                <a-assets>
                    <video 
                        id="arVideo" 
                        src="https://freela.oss-cn-beijing.aliyuncs.com/AvatarGPTtest/Aurora01.mp4"
                        autoplay 
                        loop 
                        muted 
                        playsinline 
                        webkit-playsinline
                        crossorigin="anonymous"
                        preload="auto">
                    </video>
                </a-assets>

                <a-camera 
                    position="0 0 0" 
                    look-controls="enabled: false"
                    wasd-controls="enabled: false">
                </a-camera>

                <a-entity id="targetEntity" mindar-image-target="targetIndex: 0">
                    <a-video 
                        id="videoPlane"
                        src="#arVideo"
                        width="1.2"
                        height="0.675"
                        position="0 0 0.1"
                        rotation="-90 0 0"
                        opacity="0.95"
                        visible="false">
                    </a-video>
                    
                    <a-ring 
                        color="#FFD700" 
                        radius-inner="0.7" 
                        radius-outer="0.75"
                        position="0 0 0.05"
                        rotation="-90 0 0"
                        opacity="0.8"
                        visible="false"
                        animation="property: rotation; to: -90 360 0; loop: true; dur: 8000">
                    </a-ring>
                </a-entity>
            </a-scene>
        </div>
        
        <!-- 状态指示器 -->
        <div class="status-overlay" id="statusOverlay">
            <div class="status-icon" id="statusIcon">📱</div>
            <div class="status-text" id="statusText">将摄像头对准千佛洞图标</div>
            <div class="status-subtitle">保持稳定以获得最佳体验</div>
        </div>
        
        <!-- 错误提示 -->
        <div class="error-overlay" id="errorOverlay">
            <div id="errorText">错误信息</div>
            <button class="error-button" onclick="location.reload()">重新尝试</button>
        </div>
        
        <!-- 调试信息 -->
        <div class="debug-overlay" id="debugOverlay">
            <div>状态: <span id="debugStatus">未启动</span></div>
            <div>摄像头: <span id="debugCamera">--</span></div>
            <div>MindAR: <span id="debugMindAR">--</span></div>
            <div>目标: <span id="debugTarget">--</span></div>
        </div>
    </div>

    <script>
        // 全局变量
        let stream = null;
        let isARStarted = false;
        let arInitialized = false;
        
        // UI元素
        const startOverlay = document.getElementById('startOverlay');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const arContainer = document.getElementById('arContainer');
        const statusOverlay = document.getElementById('statusOverlay');
        const errorOverlay = document.getElementById('errorOverlay');
        const debugOverlay = document.getElementById('debugOverlay');
        
        // 调试函数
        function log(message) {
            console.log(`[AR] ${message}`);
            updateDebugStatus('状态', message);
        }
        
        function updateDebugStatus(key, value) {
            const element = document.getElementById('debug' + key);
            if (element) {
                element.textContent = value;
            }
        }
        
        function toggleDebug() {
            const isVisible = debugOverlay.style.display === 'block';
            debugOverlay.style.display = isVisible ? 'none' : 'block';
        }
        
        function showError(message) {
            log(`错误: ${message}`);
            document.getElementById('errorText').textContent = message;
            errorOverlay.style.display = 'block';
            loadingOverlay.style.display = 'none';
        }
        
        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
            log(text);
        }
        
        // 完成AR初始化
        function completeARInit() {
            if (arInitialized) return;
            
            arInitialized = true;
            updateDebugStatus('MindAR', '✅ 运行中');
            
            // 隐藏加载界面，显示状态栏
            loadingOverlay.style.display = 'none';
            statusOverlay.style.display = 'block';
            
            updateStatus('🔍', '寻找千佛洞图标...');
            
            // 设置目标检测事件（移到这里确保在正确时机绑定）
            setupTargetEvents();
        }
        
        // 检查MindAR状态
        function checkMindARStatus() {
            const scene = document.getElementById('arScene');
            
            log('检查场景状态...');
            log(`场景已加载: ${scene.hasLoaded}`);
            log(`场景是否播放: ${scene.is('playing')}`);
            
            // 检查是否有canvas元素（表示渲染已开始）
            const canvas = scene.querySelector('canvas');
            if (canvas) {
                log('发现渲染canvas，AR可能已启动');
                completeARInit();
                return;
            }
            
            // 如果5秒后还没有canvas，强制启动
            setTimeout(() => {
                if (!arInitialized) {
                    const canvas = scene.querySelector('canvas');
                    if (canvas) {
                        log('延迟发现canvas，强制完成初始化');
                        completeARInit();
                    } else {
                        log('未发现canvas，尝试强制启动');
                        forceStartAR();
                    }
                }
            }, 5000);
        }
        
        // 强制启动AR
        function forceStartAR() {
            log('强制启动AR模式');
            updateLoadingText('强制启动AR...');
            
            // 直接显示AR界面
            setTimeout(() => {
                completeARInit();
                updateStatus('⚠️', '强制启动模式 - 将摄像头对准千佛洞图标');
            }, 1000);
        }
        
        // 设置目标检测事件
        function setupTargetEvents() {
            log('设置目标检测事件...');
            
            const targetEntity = document.getElementById('targetEntity');
            const videoPlane = document.getElementById('videoPlane');
            const ring = targetEntity.querySelector('a-ring');
            
            if (!targetEntity) {
                log('警告: 未找到目标实体');
                return;
            }
            
            targetEntity.addEventListener('targetFound', function() {
                log('🎯 检测到千佛洞图标！');
                updateDebugStatus('Target', '✅ 已检测');
                
                // 显示AR内容
                if (videoPlane) videoPlane.setAttribute('visible', 'true');
                if (ring) ring.setAttribute('visible', 'true');
                
                // 确保视频播放
                const video = document.getElementById('arVideo');
                if (video && video.paused) {
                    video.play().catch(e => log('视频播放失败: ' + e.message));
                }
                
                updateStatus('✨', 'AR内容已激活！');
            });
            
            targetEntity.addEventListener('targetLost', function() {
                log('📱 目标图像丢失');
                updateDebugStatus('Target', '❌ 丢失');
                
                if (videoPlane) videoPlane.setAttribute('visible', 'false');
                if (ring) ring.setAttribute('visible', 'false');
                
                updateStatus('🔍', '寻找千佛洞图标...');
            });
            
            log('目标检测事件设置完成');
        }
        
        // 启动AR（参考面部检测的启动流程）
        async function startAR() {
            if (isARStarted) return;
            
            try {
                // 隐藏启动界面，显示加载界面
                startOverlay.style.display = 'none';
                loadingOverlay.style.display = 'flex';
                
                updateLoadingText('检查设备兼容性...');
                updateDebugStatus('Status', '检查兼容性');
                
                // 检查基础支持
                if (!navigator.mediaDevices?.getUserMedia) {
                    throw new Error('您的浏览器不支持摄像头访问');
                }
                
                updateLoadingText('请求摄像头权限...');
                updateDebugStatus('Camera', '请求权限');
                
                // 摄像头配置（使用后摄像头）
                const constraints = {
                    video: {
                        facingMode: 'environment', // 后摄像头
                        width: { ideal: 1280, min: 640 },
                        height: { ideal: 720, min: 480 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                };
                
                // 请求摄像头权限
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                log('摄像头权限获取成功');
                updateDebugStatus('Camera', '✅ 已获取');
                
                updateLoadingText('初始化AR引擎...');
                updateDebugStatus('MindAR', '初始化中');
                
                // 显示AR容器
                arContainer.style.display = 'block';
                
                // 等待A-Frame场景准备好
                const scene = document.getElementById('arScene');
                
                updateLoadingText('正在加载AR模型...');
                
                // 设置超时检测
                const initTimeout = setTimeout(() => {
                    if (!arInitialized) {
                        log('AR初始化超时，强制启动');
                        forceStartAR();
                    }
                }, 8000);
                
                // 监听多个可能的事件
                scene.addEventListener('renderstart', function() {
                    log('AR渲染开始 (renderstart)');
                    clearTimeout(initTimeout);
                    completeARInit();
                });
                
                scene.addEventListener('loaded', function() {
                    log('A-Frame场景加载完成');
                    // 延迟一下再检查MindAR状态
                    setTimeout(() => {
                        if (!arInitialized) {
                            log('手动检查MindAR状态...');
                            checkMindARStatus();
                        }
                    }, 2000);
                });
                
                // 检查是否已经渲染
                setTimeout(() => {
                    if (scene.hasLoaded && !arInitialized) {
                        log('场景已加载，检查渲染状态...');
                        checkMindARStatus();
                    }
                }, 3000);
                
                // 目标检测事件
                const targetEntity = document.getElementById('targetEntity');
                const videoPlane = document.getElementById('videoPlane');
                const ring = targetEntity.querySelector('a-ring');
                
                targetEntity.addEventListener('targetFound', function() {
                    log('🎯 检测到千佛洞图标！');
                    updateDebugStatus('Target', '✅ 已检测');
                    
                    // 显示AR内容
                    videoPlane.setAttribute('visible', 'true');
                    ring.setAttribute('visible', 'true');
                    
                    // 确保视频播放
                    const video = document.getElementById('arVideo');
                    if (video.paused) {
                        video.play().catch(e => log('视频播放失败: ' + e.message));
                    }
                    
                    updateStatus('✨', 'AR内容已激活！');
                });
                
                targetEntity.addEventListener('targetLost', function() {
                    log('📱 目标图像丢失');
                    updateDebugStatus('Target', '❌ 丢失');
                    
                    videoPlane.setAttribute('visible', 'false');
                    ring.setAttribute('visible', 'false');
                    
                    updateStatus('🔍', '寻找千佛洞图标...');
                });
                
                isARStarted = true;
                updateDebugStatus('Status', 'AR已启动');
                
            } catch (error) {
                console.error('AR启动失败:', error);
                
                let userMessage = 'AR启动失败: ';
                if (error.name === 'NotAllowedError') {
                    userMessage += '请允许摄像头权限';
                } else if (error.name === 'NotFoundError') {
                    userMessage += '未找到摄像头设备';
                } else if (error.name === 'NotSupportedError') {
                    userMessage += '您的设备不支持此功能';
                } else {
                    userMessage += error.message;
                }
                
                updateDebugStatus('Status', '启动失败');
                showError(userMessage);
                
                // 清理资源
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
            }
        }
        
        // 页面加载完成
        window.addEventListener('load', function() {
            log('页面加载完成');
            updateDebugStatus('Status', '就绪');
        });
        
        // 页面卸载清理
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
        
        // 预加载视频
        const video = document.getElementById('arVideo');
        video.addEventListener('loadeddata', function() {
            log('视频资源加载完成');
        });
        
        video.addEventListener('error', function(e) {
            log('视频加载失败: ' + e.message);
        });
        
        // 检查mind文件
        fetch('https://arplus.github.io/AR-SLAM/qianfo.mind')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                log('mind文件检查通过');
            })
            .catch(err => {
                log('mind文件检查失败: ' + err.message);
            });
    </script>
</body>
</html>
