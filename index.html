<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }
        .start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 1000; color: white;}
        .start-button { background: #4CAF50; border: none; color: white; padding: 15px 32px; text-align: center; font-size: 16px; border-radius: 8px; cursor: pointer; margin-top: 20px;}
        .start-button:hover { background: #45a049;}
        .start-button:disabled { background: #666; cursor: not-allowed;}
        .hidden { display: none;}
        .status { position: fixed; top: 10px; left: 10px; background: rgba(0, 0, 0, 0.8); color: #4CAF50; padding: 10px 15px; border-radius: 20px; z-index: 999; font-size: 14px; border: 1px solid rgba(76, 175, 80, 0.3); max-width: 300px;}
        a-scene { width: 100% !important; height: 100% !important;}
        a-scene canvas { width: 100% !important; height: 100% !important;}
        .loading-spinner { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; border: 3px solid rgba(76, 175, 80, 0.3); border-top: 3px solid #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; z-index: 500;}
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        .progress-info { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 15px 25px; border-radius: 25px; z-index: 999; font-size: 16px; text-align: center; min-width: 200px;}
        .progress-bar { width: 100%; height: 4px; background: rgba(255, 255, 255, 0.3); border-radius: 2px; margin-top: 10px; overflow: hidden;}
        .progress-fill { height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s ease;}
        video { width: 100% !important; height: 100% !important; object-fit: cover !important;}
    </style>
</head>
<body>
    <!-- å¯åŠ¨ç•Œé¢ -->
    <div class="start-overlay" id="startOverlay">
        <h2>ğŸ›ï¸ åƒä½›æ´ARä½“éªŒ</h2>
        <p>ç‚¹å‡»å¼€å§‹å°†ç›´æ¥å¯åŠ¨ARæ‘„åƒå¤´</p>
        <p style="font-size: 14px; opacity: 0.8;">æ‘„åƒå¤´å’ŒARè¯†åˆ«å°†åŒæ—¶åˆå§‹åŒ–</p>
        <button class="start-button" id="startButton">å¯åŠ¨ARæ‘„åƒå¤´</button>
        <div style="margin-top: 20px; font-size: 14px; opacity: 0.8;">
            è¯·ç¡®ä¿å…‰çº¿å……è¶³å¹¶å…è®¸æ‘„åƒå¤´æƒé™<br>
            é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ
        </div>
    </div>
    <!-- çŠ¶æ€æ˜¾ç¤º -->
    <div class="status" id="status">å‡†å¤‡å¯åŠ¨ARæ‘„åƒå¤´</div>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading-spinner hidden" id="loadingSpinner"></div>
    <!-- è¿›åº¦ä¿¡æ¯ -->
    <div class="progress-info hidden" id="progressInfo">
        <div id="progressText">æ­£åœ¨åˆå§‹åŒ–...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>
    <!-- ARåœºæ™¯ -->
    <a-scene 
        id="arScene"
        mindar-image="imageTargetSrc: ./qianfo.mind; autoStart: false; uiLoading: no; uiScanning: no; uiError: no;" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false"
        embedded
        renderer="colorManagement: true, physicallyCorrectLights: true">
        
        <a-assets>
            <video 
                id="arVideo" 
                src="https://freela.oss-cn-beijing.aliyuncs.com/AvatarGPTtest/Aurora01.mp4"
                loop 
                muted 
                playsinline 
                webkit-playsinline
                crossorigin="anonymous">
            </video>
        </a-assets>
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        
        <a-entity mindar-image-target="targetIndex: 0">
            <a-video 
                src="#arVideo"
                width="1" 
                height="0.6" 
                position="0 0 0" 
                rotation="-90 0 0"
                opacity="0.9">
            </a-video>
        </a-entity>
    </a-scene>
    <script>
        // DOMå…ƒç´ 
        const startOverlay = document.getElementById('startOverlay');
        const startButton = document.getElementById('startButton');
        const status = document.getElementById('status');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const progressInfo = document.getElementById('progressInfo');
        const progressText = document.getElementById('progressText');
        const progressFill = document.getElementById('progressFill');
        const arScene = document.getElementById('arScene');
        
        let isStarting = false;
        let arSystem = null; // mindar-image system

        function updateStatus(message) {
            status.textContent = message;
            console.log('çŠ¶æ€:', message);
        }
        function updateProgress(text, percent) {
            progressText.textContent = text;
            progressFill.style.width = percent + '%';
        }

        // ç›‘å¬ARè¯†åˆ«äº‹ä»¶
        function setupAREvents() {
            const targetEntity = document.querySelector('[mindar-image-target]');
            const arVideo = document.querySelector('#arVideo');
            if (targetEntity && arVideo) {
                targetEntity.addEventListener('targetFound', () => {
                    updateStatus('ğŸ‰ æ£€æµ‹åˆ°åƒä½›æ´ï¼æ­£åœ¨æ’­æ”¾è§†é¢‘');
                    arVideo.play().catch(e => {
                        console.error('ARè§†é¢‘æ’­æ”¾å¤±è´¥:', e);
                        updateStatus('è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œä½†ç›®æ ‡æ£€æµ‹æˆåŠŸ');
                    });
                });
                targetEntity.addEventListener('targetLost', () => {
                    updateStatus('ğŸ” ç›®æ ‡ä¸¢å¤± - è¯·é‡æ–°æ‰«æåƒä½›æ´å›¾ç‰‡');
                    arVideo.pause();
                });
            }
        }

        // ä¸»å¯åŠ¨æµç¨‹
        async function startARSystem() {
            try {
                if (isStarting) return;
                isStarting = true;
                updateStatus('æ­£åœ¨å¯åŠ¨ARç³»ç»Ÿ...');
                startButton.disabled = true;
                loadingSpinner.classList.remove('hidden');
                progressInfo.classList.remove('hidden');

                // æ­¥éª¤1ï¼šç­‰å¾…A-Frameåœºæ™¯åŠ è½½
                updateProgress('æ­£åœ¨åŠ è½½A-Frameåœºæ™¯...', 10);
                if (!arScene.hasLoaded) {
                    await new Promise(resolve => {
                        arScene.addEventListener('loaded', resolve, { once: true });
                    });
                }
                updateProgress('A-Frameåœºæ™¯åŠ è½½å®Œæˆ', 25);

                // æ­¥éª¤2ï¼šç­‰å¾…mindar-imageç³»ç»Ÿåˆå§‹åŒ–ï¼ˆç”¨arReadyäº‹ä»¶ï¼‰
                updateProgress('ç­‰å¾…ARç³»ç»Ÿå°±ç»ª...', 35);
                await new Promise((resolve, reject) => {
                    // ä»…é¦–æ¬¡ç›‘å¬
                    const readyHandler = () => {
                        arSystem = arScene.systems["mindar-image"];
                        resolve();
                    };
                    // å¦‚æœå·²readyï¼Œç›´æ¥resolve
                    if (arScene.systems["mindar-image"] && arScene.systems["mindar-image"].ready) {
                        arSystem = arScene.systems["mindar-image"];
                        resolve();
                    } else {
                        arScene.addEventListener('arReady', readyHandler, { once: true });
                        setTimeout(() => {
                            reject(new Error('MindARç³»ç»Ÿåˆå§‹åŒ–è¶…æ—¶'));
                        }, 15000);
                    }
                });
                updateProgress('ARç³»ç»Ÿå·²å°±ç»ª', 60);

                // æ­¥éª¤3ï¼šè·å–æ‘„åƒå¤´æƒé™
                updateProgress('æ£€æµ‹æ‘„åƒå¤´æƒé™...', 70);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment', width: {ideal:1280}, height: {ideal:720}}
                    });
                    stream.getTracks().forEach(track => track.stop());
                    updateProgress('æ‘„åƒå¤´æƒé™å·²è·å–', 80);
                } catch (permissionError) {
                    throw new Error('æ‘„åƒå¤´æƒé™è¢«æ‹’ç»æˆ–è®¾å¤‡ä¸å¯ç”¨');
                }

                // æ­¥éª¤4ï¼šéšè—overlayå†å¯åŠ¨ARï¼ˆé¿å…overlayæŒ¡ä½æ‘„åƒå¤´ï¼‰
                updateProgress('å¯åŠ¨ARè¯†åˆ«...', 90);
                startOverlay.classList.add('hidden');
                // å¯åŠ¨MindAR
                await arSystem.start();
                updateProgress('ARç³»ç»Ÿå¯åŠ¨æˆåŠŸï¼', 100);

                setTimeout(() => {
                    loadingSpinner.classList.add('hidden');
                    progressInfo.classList.add('hidden');
                    updateStatus('ğŸ¯ ARå·²å¯åŠ¨ - è¯·æ‰«æåƒä½›æ´å›¾ç‰‡');
                    setupAREvents();
                }, 1000);
            } catch (error) {
                console.error('ARå¯åŠ¨å¤±è´¥:', error);
                let errorMsg = 'å¯åŠ¨å¤±è´¥: ';
                let suggestions = 'è¯·å°è¯•:\n';
                if (error.message.includes('æƒé™')) {
                    errorMsg += 'æ‘„åƒå¤´æƒé™é—®é¢˜';
                    suggestions += '1. å…è®¸æ‘„åƒå¤´æƒé™\n2. åˆ·æ–°é¡µé¢é‡è¯•';
                } else if (error.message.includes('è¶…æ—¶')) {
                    errorMsg += 'ç»„ä»¶åŠ è½½è¶…æ—¶';
                    suggestions += '1. æ£€æŸ¥ç½‘ç»œè¿æ¥\n2. åˆ·æ–°é¡µé¢é‡è¯•';
                } else if (error.message.includes('MindAR')) {
                    errorMsg += 'ARç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥';
                    suggestions += '1. åˆ·æ–°é¡µé¢\n2. æ£€æŸ¥qianfo.mindæ–‡ä»¶\n3. å°è¯•ä½¿ç”¨Chromeæµè§ˆå™¨';
                } else {
                    errorMsg += error.message;
                    suggestions += '1. åˆ·æ–°é¡µé¢\n2. æ£€æŸ¥ç½‘ç»œè¿æ¥\n3. å°è¯•å…¶ä»–æµè§ˆå™¨';
                }
                updateStatus(`âŒ ${errorMsg}`);
                updateProgress(`é”™è¯¯: ${error.message}`, 0);
                startButton.disabled = false;
                startButton.textContent = 'é‡æ–°å¯åŠ¨';
                loadingSpinner.classList.add('hidden');
                alert(errorMsg + '\n\n' + suggestions);
                isStarting = false;
            }
        }

        startButton.addEventListener('click', () => {
            startARSystem();
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (arSystem) {
                try { arSystem.stop(); } catch (e) { console.log('ARç³»ç»Ÿæ¸…ç†:', e); }
            }
        });
    </script>
</body>
</html>
